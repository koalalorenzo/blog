{{ $class := (.Get "class") }}
{{ $caption := (.Get "caption") }}
{{ $original := (.Page.Resources.ByType "image").GetMatch (printf "*%s" (.Get "src")) }}

{{ $tiny := "" }}
{{ $small := "" }}
{{ $medium := "" }}
{{ $large := "" }}

{{ with $original }}
  {{ if gt .Width 256 }}
  {{ $tiny = (.Resize "256x webp q75") }}
  {{ end }}

  {{ if gt .Width 512 }}
  {{ $small = (.Resize "512x webp q75") }}
  {{ end }}

  {{ if gt .Width 1024 }}
  {{ $medium = (.Resize "1024x webp q75") }}
  {{ end }}

  {{ if gt .Width 2048 }}
  {{ $large = (.Resize "2048x webp q75") }}
  {{ end }}
<a href="{{ .RelPermalink }}" target="_blank">
  <figure {{ if $class }}class="{{ $class }}"{{ end }}>
    <img
      srcset="
        {{ if gt .Width 256 }}
        {{- with $tiny.RelPermalink -}}{{.}} 256w{{- end -}}
        {{- end -}}

        {{ if gt .Width 512 }}
        {{- with $small.RelPermalink -}}, {{.}} 512w{{- end -}}
        {{- end -}}

        {{ if gt .Width 1024 }}
        {{- with $medium.RelPermalink -}}, {{.}} 1024w{{- end -}}
        {{- end -}}

        {{ if gt .Width 2048 }}
        {{- with $large.RelPermalink -}}, {{.}} 2048w{{- end -}}
        {{ end }}
      "
      {{ if gt .Width 1024 }}
      src="{{ $medium.RelPermalink }}"
      {{ else }}
      src="{{ .RelPermalink }}"
      {{ end }}
      alt="{{ $caption }}">
      {{ if $caption }}
      <figcaption>
        {{ $caption | markdownify }}
      </figcaption>
      {{ end }}
  </figure>
</a>
{{ end }}
<div class="clearfix"></div>
